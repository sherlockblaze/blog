---
title: 高并发系统设计 40 问
tags:
  - 极客时间笔记
date: 2019-09-18
---

> 本文总结自极客时间专栏，[高并发系统设计40问](https://time.geekbang.org/column/intro/230)

## 支持原版

![海报](https://sherlockblaze.com/resources/img/time-geekbang/高并发系统设计/海报.jpg)

## 为什么要学习高并发系统设计

**思考题**

- 微博中，明星动辄拥有几千万甚至上亿的粉丝，如何保证明星发布的内容让粉丝实时地看到
- 淘宝双十一，如何保证衣服不会超卖
- 12306 订购火车票，如何保证千万人访问的同时也能支持正常抢票

同样是缓存的使用，在低并发下你只需要了解基本的使用方式，但在高并发场景下需要关注**缓存命中率、如何应对缓存穿透、如何避免雪崩、如何解决缓存一致性等问题**，增加了设计方案的复杂度，对设计者能力的要求也会更高。

## 学习目标

- 掌握高并发系统设计的“套路”
- 理解基本的系统设计思想，对新的知识触类旁通，举一反三
- 突破技术的瓶颈，突破所处平台的限制，具备一个优秀架构师的资质

虽说每家公司所处的行业不同，业务场景不同，但是设计和优化的思想却是万变不离其宗。

本篇总结里的经验是一个个的“小套路”，它们相互联系，形成一套指引进行高并发系统设计的指示体系，其中包括了理论知识的讲解、问题场景的介绍、问题分析的过程，以及解决问题的思路。

当掌握这些“套路”后，就能明确地知道，系统处于某一阶段时，可能会面临的问题，然后及时找到架构设计优化的思路解决这些问题，提升系统性能。

## 系统的演进过程

- 最简单的系统设计满足业务需求和流量现状，选择最熟悉的技术体系
- 随着流量的增加和业务的变化，修正架构中存在问题的点，如单点问题，横向扩展问题，性能无法满足需求的组件。在这个过程中，选择社区成熟的、团队熟悉的组件来解决问题，社区没有合适解决方案的前提下才自己造轮子
- 对架构的小修小补无法满足需求时，考虑重构、重写等大的调整方式以解决现有问题

**高并发系统的演进应该是循序渐进，以解决系统中存在的问题为目的和驱动力的**

## 高并发系统的通用设计方法是什么

目标是抵抗巨大流量的冲击，让流量更加平稳地被系统中的服务和组件处理。

> 课程比喻： 从古至今，长江和黄河流域水患不断。
> **远古时期，大禹曾拓宽河道，清除淤沙让流水更加流畅**
> **都江堰作为史上最成功的治水案例之一，用引流将岷江之水分流到多个支流中，以分担水流压力**
> **三门峡和葛洲坝通过建造水库将水引入水库先存储起来，然后再想办法把水库中的水缓缓地排出去，以此提高下游的抗洪能力**

在应对高并发大流量时也会采用类似“抵御洪水”的方案：
- Scale-out（横向扩展）：分而治之是一种常见的高并发系统设计方法，采用分布式部署的方式把流量分开，让每个服务器都承担一部分并发和流量
- 缓存：使用缓存来提高系统的性能，就好比用“拓宽河道”的方式抵抗高并发大流量的冲击
- 异步：在某些场景下，未处理完成之前，可以先让请求返回，在数据准备好之后再通知请求方，这样可以在单位时间内处理更多的请求

### Scale-up 和 Scale-out

- Scale-up，通过购买性能更好的硬件来提升系统的并发处理能力，比如目前 4 核 4G 每秒可以处理 200 次请求，如果要处理 400 次请求呢？把机器的硬件提升到 8 核 8G（硬件资源的提升可能不是线性，仅供参考）
- Scale-out，通过将多个低性能的机器组成一个分布式集群来共同抵御高并发流量的冲击

**使用时机**

一般在系统设计初期会考虑使用 Scale-up 的方式，方案简单，但系统并发超过了单机极限时，就需要使用 Scale-out 的方式了。

Scale-out 虽可以突破单机限制，但也会引入一些复杂问题 —— 如何保证高可用？如何进行状态同步？如何无感知增加和删除节点？

### 缓存

使用缓存的主要作用是提升系统的访问性能。

可以将任何降低响应事件的中间存储都称为缓存，缓存的思想遍布很多设计领域，比如操作系统中 CPU 有多级缓存，文件有 Page Cache 缓存。

### 异步处理

同步调用代表调用方要阻塞等待被调用方法中的逻辑执行完成。这种方式下，当被调用方响应时间较长，会造成调用方长久的阻塞，在高并发系统下会造成整体系统性能下降甚至发生雪崩。

异步调用不需要等待方法逻辑执行完成就可以返回执行其他的逻辑，在被调用方法执行完毕后再通过回调、事件通知等方式将结果反馈给调用方。

异步调用在大规模高并发系统中被大量使用，比如 12306。

订票时，页面会显示系统正在排队，代表着系统在异步处理订票请求。系统中查询余票、下单和更改余票状态都是比较耗时的操作，可能涉及多个内部系统的互相调用，如果是同步调用就会像 12306 刚刚上线时那样，高峰期永远不可能下单成功。

**处理逻辑后移到异步处理程序中，Web 服务的压力小了，资源占用的少了，自然就能接收更多的用户订票请求，系统承受高并发的能力也就提升了。**

![12306异步处理订票操作示意图](https://sherlockblaze.com/resources/img/time-geekbang/高并发系统设计/12306异步处理订票操作示意图.png)
