---
title: 分布式架构入门
tags:
  - architecture
  - tec
date: 2019-04-24
---

## 设计

### 架构原理

如图：

![principle](https://sherlockblaze.com/resources/img/profession/architectures/distributed-architecture-principle.png)

以上图片将分布式框架的架构抽象为三层。

1. RPC 层： 包括底层通信框架（NIO框架的封装、共有协议的封装等）、序列化和反序列化框架、用于屏蔽底层通信协议细节和序列化方式差异的Remoting框架。
2. Filter Chain 层： 服务调用职责链，提供多种服务调用切面供框架自身和使用者扩展，例如负载均衡、服务调用性能统计、服务调用完成通知机制、失败重发等。
3. Service 层： 提供服务。

从功能角度看，分布式服务框架通常会包含另外两个重要功能：

1. 服务治理中心
2. 服务注册中心

根据业务需求的不同，具体实现细节也存在很大差异，以服务注册中心为例，HSF 使用的是基于数据库的 ConfigServer， Dubbo 默认使用的是 ZooKeeper。

**服务注册中心**负责服务的发布和通知，通常支持对等集群部署，某一个服务注册中心宕机不会导致整个服务注册中心集群不可用。即便整个服务注册中心全部宕机，也只影响新服务的注册和发布，不影响已经发布的服务和访问。

**服务治理中心**通常包含服务治理借口和服务治理 Portal，通过服务治理 Portal 对服务的运行状态、历史数据、健康度和调用关系等进行可视化的分析和维护，目标就是要持续优化服务，防止服务架构腐化，保证服务高质量运行。

### 功能特性

仅学习公共能力。

> 注: 下表中，功能名列和说明列中相同标注项项相互对应。

| 特征名 | 功能名 | 说明 |
| ----- | ----- | --- |
| 服务订阅发布 | 1. 配置化发布和引用服务<br/> 2. 服务自动发现机制<br/> 3. 服务在线注册和去注册 | 1. 支持通过 XML 配置的方式发布和引入服务，降低对业务代码的侵入<br/> 2. 支持服务实时自动发现，由注册中心推送服务地址，消费者不需要配置服务提供者地址，服务地址透明化<br/> 3. 支持动态注册新服务，也支持运行态取消某个服务的注册 |
| 服务路由 | 1. 默认提供随机路由、轮循、基于权重的路由策略等<br/> 2. 粘滞连接<br/> 3. 路由定制 | 1. 默认提供常用的路由策略，避免每个框架使用者都重复开发<br/> 2. 总是向同一个提供方发起请求，除非此提供方挂掉，再切换到另一台<br/> 3. 支持用户自定义路由策略，扩展平台的功能 |
| 集群容错 | 1. Failover<br/> 2. Failback<br/> 3. Failfast | 1. 失败也可以自动切换，当出现失败，重试其他服务器，通常用于读操作；也可用于幂等性写操作<br/> 2. 失败后自动恢复，后台记录失败请求，定时重发，通常用于消息通知操作<br/> 3. 快速失败，只发起一次调用，失败立刻报错，通常用于非幂等性的写操作 |
| 服务调用 | 1. 同步调用<br/> 2. 异步调用<br/> 3. 并行调用 | 1. 消费者发起服务调用之后，同步并阻塞等待服务段响应<br/> 2. 消费者发起服务调用之后，不阻塞立即返回，由服务端返回响应应答后异步通知消费者<br/> 3. 消费者同时对多个服务提供者批量发起服务调用请求，批量发起请求后，集中等待应答 |
| 多协议 | 1. 私有协议<br/> 2. 公有协议<br/> | 1. 支持二进制等私有协议，支持私有协议定制和扩展<br/> 2. 提供 Web Service 等公有协议，用于外部服务对接 |
| 序列化方式 | 1. 二进制类序列化<br/> 2. 文本类序列化 | 1. 支持 Thrift、Protocol Buffer 等二进制协议，提升通用性和可读性<br/> 2. 支持 JSON、XML等文本类型的序列化方式，提升通用性和可读性 |
| 统一配置 | 1. 本地静态配置<br/> 2. 基于配置中心的动态配置 | 1. 安装部署修改一次，运行态不修改的配置，可以存放本地配置文件中<br/> 2. 运行态需要调整的参数，同意放到配置中心(服务注册中心)，修改之后统一下发，实时生效 |

上表中描述的功能并非需要100%支持，具体问题具体分析，可以根据需求进行裁剪。

### 性能特性

本地API调用编程跨进程远程服务调用，网络通信、消息序列化和反序列化、反射调用和动态代理等都会导致性能损耗、时延增加。

所以分布式服务框架有以下性能特征：

| 线性特性 | 说明 |
| ---------- | ------ |
| 高性能 | 在同等资源占用情况下，单服务提供者的TPS要尽量高 |
| 低时延 | 在同等资源占用情况下，服务调用时延要尽量低 |
| 性能线性增长 | 扩展服务提供者，性能要能够线性增长 |

### 可靠性

应用由单机调用演进到分布式部署之后，由于网络故障、服务提供者故障等因素，会导致业务失败率增加，分布式服务框架需要具备很强的可靠性，来保证业务的成功率，可靠性总结如下表：

> 注: 下表中，功能名列和说明列中相同标注项项相互对应。

| 特征名 | 功能名 | 说明 |
| -------- | ------- | ------ |
| 服务注册中心 | 1. 服务健康状态检测<br/> 2. 故障切换<br/> 3. 高 HA | 1. 注册中心通过心跳检测服务提供者的存在，服务提供者宕机，注册中心将立即推送事件通知消费者<br/> 2. 注册中心对等集群，任意一台宕掉后，将自动切换另一台<br/> 3. 注册中心全部宕掉后，服务提供者和服务消费者仍能通过本地缓存通信 |
| 消除单点故障 | 1. 服务无状态<br/> 2. 服务集群容错 | 1. 服务提供者无状态，任意一台宕掉以后，不影响使用<br/> 2. 只要集群中有一台机器的服务提供者可用，业务就不会中断 |
| 链路健壮性 | 1. 心跳检测<br/> 2. 断连重连机制<br/> | 1. 链路空闲时没有业务消息，通过定时心跳检测链路是否可用<br/> 2. 链路断连后，根据客户端配置的重连策略定时重连，重连成功之前消息不会路由到断连的服务提供者上 |

### 服务治理

服务治理是分布式框架重要的特性。

> 注: 下表中，功能名列和说明列中相同标注项项相互对应。

| 特性名 | 功能名 | 说明 |
| -------  | -------- | ----- |
| 