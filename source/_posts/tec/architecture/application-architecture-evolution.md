---
title: 应用架构演进
tags:
  - architecture
  - tec
date: 2019-04-23
---

## SOA 服务化架构

SOA 是一种粗粒度、松耦合的以服务为中心的架构，接口之间通过定义明确的协议和接口进行通信。

### 面向服务设计的原则

1. 服务可复用
2. 服务共享一个标准契约
3. 服务是松耦合的
4. 服务是底层逻辑的抽象
5. 服务是可组合、可编排的
6. 服务是自治的
7. 服务是无状态的
8. 服务是可被自动发现的

### 服务治理

随着服务数量的增多，会带来越来越多的挑战：

1. 分布式框架下的服务调用性能
2. 服务化架构如何支持线性扩展
3. 如何实现高效、实时的服务多维度监控
4. 大规模分布式环境下的故障快速定界和定位
5. 分布式环境下海量日志在线检索、模糊查询
6. 服务的流控、超时控制、服务升降机等管控手段
7. 服务的划分原则，如何实现最大程度服用
...

此时，SOA的服务治理是关键。

1. **服务定义**： SOA 治理最基础的方面就是监视服务的创建过程。必须对服务进行标识，描述其功能，确定其行为范围并设计其接口。创建服务时，需要与使用这些服务的团队进行协调，以确保服务能够满足消费者需求，避免重复工作。
2. **服务生命周期管理**： 服务需要进行规划、设计、实现、部署、维护，并最后下线。服务开发生命周期通常都具有五个主要的阶段。**计划阶段** —— 已标识了新服务并正在设计中，不过尚未实现或正在实现中；**测试阶段** —— 服务完成开发后，上线前必须对服务进行测试，有些测试可能需要在灰度环境中执行，此环境会作为服务上线前的测试床来模拟生产环境进行最后验证； **运行阶段** —— 生产环境中正在运行的服务； **弃用阶段** —— 尽管该服务仍然在生产环境中运行，但是不会长时间运行，过一段时间将会下线，警告服务消费者尽快停止使用此服务。 **废弃阶段** —— 这是服务的最后一个阶段，表示一个生命周期结束的服务。注册中心可以将该服务物理删除，也可以逻辑删除，表示该服务已经被废弃。
3. **服务版本治理**： 服务发布不久，服务提供者就开始根据需要对服务进行修改。包括问题修复，添加新的功能，有时还需删除非必须的功能。服务修改之后，需要对服务进行重新编译和打包，发布新版本的服务。新版本的前向兼容性，灰度发布等需要按照统一的策略进行管理。
4. **服务注册中心**： 服务提供者如何发布服务？服务消费者如何订阅服务？已经发布的服务如何重新注册和下线，新注册服务如何被消费者动态发现，需要统一的服务注册中心支持服务的**订阅发布**和**动态发现**机制。
5. **服务监控**： 服务监控中心需要对服务的调用、成功率、吞吐率等数据进行实时采样和汇总，通过图形化报表的形式展示，以方便运维人员对服务的运行质量进行实时分析和掌控。
6. **运行期服务质量保障**： 包括服务限流、服务迁入迁出、服务升降机、服务权重调整和服务超时控制等，通过运行期的动态治理，可以在不重启服务的前提下达到快速提升服务运行质量的目标。
7. **快速的故障定界定位手段**： 故障定界定位主要包括两方面的内容。a. 大规模分布式环境下海量业务/平台日志的采集、汇总和实时在线检索，支持多维度的条件检索、模糊查询，可以快速地在线查看各种系统运行日志，方便问题定位；　b. 分布式消息追踪，通过调用链打通业务、服务调用和异常，发现线上系统故障源；通过在线和离线调用链大数据分析，得到链路各个依赖的稳定性指标，梳理依赖链路风险表，识别系统核心功能的服务调用依赖关系，评估可能的最大风险点，针对性改进以预防风险，同时为容量规划和扩容提供数据决策依据。
8. **服务安全**： 是否允许任何人调用任何服务，数据敏感型服务是否允许所有用户访问所有数据，服务使用者和提供者之间交换的数据是否需要保护，服务是否需要做安全认证，对内对外安全策略差异等。服务调用必须能够提供安全功能，对服务的访问进行权限控制，将服务的访问权仅限于授权使用者。用户安全标识需要在服务调用中携带，用于授权敏感数据的访问。服务安全访问策略有多种，例如可以通过动态生成令牌（Token）的方式做安全访问授权，服务提供者动态生成令牌（Token）并告知服务注册中心，由注册中心是否告知消费方，这样就能在注册页面上做复杂的授权模型。

## 微服务架构

微服务架构（MSA）是一种服务化架构风格，通过将功能分散到各个离散的服务中以实现对解决方案的解耦。

特征：

1. **原子服务，专注于做一件事**： 与面向对象原则中的“单一职责原则”类似，功能越单一，对其他功能的依赖就越少，内聚性就越强，“高内聚，低耦合”
2. **高密度部署**： 重要的服务可以独立进程部署，非核心服务可以独立打包。物理机部署，可以在一台服务器上部署多个服务实例进程；如果是云端部署，可以利用LXC实现容器级部署，以降低部署成本，提升资源利用
3. **敏捷交付**： 服务由小研发团队负责设计、开发、测试、部署、线上治理、灰度发布和下线，运维整个生命周期支撑，实现真正的DevOps
4. **微自治**： 服务足够小，功能单一，可以独立打包、部署、升级、回滚和弹性伸缩，不依赖其他服务，实现局部自治

## 微服务架构对比SOA

两者的主要差异如下：

1. **服务拆分粒度**：SOA 首先要解决的是异构应用的服务化；微服务强调的是服务拆分尽可能小，最好是独立的原子服务。
2. **服务依赖**： 传统的 SOA 服务，由于需要重用已有资产，存在大量的服务间依赖；微服务的设计理念是服务自治、功能单一独立，避免依赖其他服务产生耦合，耦合会带来更高的复杂度。
3. **服务规模**： 传统的 SOA 服务粒度比较大，多数会采用多个服务合并打成 war 包的方案，因此服务的实例数比较有限；微服务强调尽可能拆分，同时很多服务会独立部署，这将导致服务规模急剧膨胀，对服务治理和运维带来新的挑战。
4. **架构差异**： 微服务化之后，服务数量的激增会引起架构质量属性的变化； 为了保证高性能、低延时，需要高性能的分布式服务框架保证微服务架构的实施。
5. **服务治理**： 传统基于 SOA Governance 的静态治理转型为服务运行态微治理、实时生效。
6. **敏捷交付**： 服务由小研发团队负责微服务设计、开发、测试、部署、线上治理、灰度发布和下线，运维整个生命周期支撑，实现真正的 DevOps。

## Cloud Native

### 起源

每个人对于 Cloud Native 的理解不尽相同，下面我们学习一下其中比较著名的三位技术领导者关于 Cloud Native 的描述。

#### Paul Fremantle

Paul Fremantle 认为 Cloud Native 只有满足了以下属性，才能保证良好的运行状态：

1. 分布式
2. 弹性
3. 多租户
4. 自服务
5. 按需计量和计费
6. 增量部署和测试

#### Adrian Cockcroft

这个要抄的详细一些。Adrian Cockcroft 在 Yow Conference 上介绍了 Netflix 在 AWS 上基于 Cloud Native 的成功应用。 Netflix 在 AWS 上运行着上万个实例，每天都有数以千计的实例被创建或删除。 Adrian Cockcroft 介绍 Netflix 的成功经验时，主要从**目标**、**原则**和**措施**等方面进行了描述。

- [目标](#目标)
- [原则](#原则)
- [措施](#措施)

##### 目标

1. 可扩展性
2. 高可用性，高可用代表了更好的用户体验
3. 敏捷， 在互联网公司，速度永远是第一位的，速度代表了良好的用户体验。Netflix 利用了 AWS，而不是自建云环境及平台服务，可以加快研发速度。
4. 效率，主要指研发效率

为了达成以上目标，Netflix 制定了五大架构原则，通过这些架构原则约束所有研发人员的思想。

##### 原则

1. 不变性，服务的实例一旦创建，将不能修改，如果要修改，则可以通过创建一个新的节点实现。
2. 关注点分离，通过微服务架构实现关注点分离，避免出现”决策瓶颈“。实际上，实现关注点分离有助于提升系统的扩展性和可用性。
3. 反脆弱性，默认所有的依赖都可能失效，在设计阶段就要考虑到如何处理这些失效问题。为了让系统更健壮，Netflix 会不断地攻击自己、主动破坏，以提醒系统要进行发脆弱性设计。
4. 高信任的组织。Netflix 是基于信任的管理风格，相信自己的员工可以做出正确的决策，倡导给基层员工自主决策权。
5. 共享，在Netflix，管理是比较透明的，共享能促进技术人员的成长。

##### 措施

1. 利用 AWS 实现可扩展性、敏捷和共享
2. 利用非标准化数据实现关注点分离
3. 利用猴子工程师实现反脆弱性
4. 利用默认开源实现敏捷、共享
5. 利用持续部署实现敏捷、不变性
6. 利用 DevOps 实现高信任组织和共享
7. 利用运行自己写的代码实现反脆弱性开发演进

#### Matt Stine

Matt Stine 认为在单体架构向 Cloud Native 迁移的过程中，需要文化、组织、技术共同变革。

1. 十二因子
2. 微服务
3. 自服务敏捷基础设施
4. 基于 API 的写作
5. 反脆弱性

每个人站立的角度不同，一千个人有一千个哈姆雷特，并且由于架构在持续演进，新技术层出不穷，Cloud Native 的形象也会不断演进。

Cloud Native 可以认为是一系列架构、研发流程、团队文化的最佳实践集合，以此支撑更快的创新速度、极致的用户体验、稳定可靠的用户服务、高效的研发效率。

### Cloud Native 的组成

![cloud-native compositions](https://sherlockblaze.com/resources/img/profession/architectures/cloud-native-composition.png)

如上图所示，分析 Cloud Native 需要从架构、研发流程、团队文化三个角度来实现，三者需要相互配合，缺一不可。

**架构角度**： Cloud Native 是以云和微服务架构作为基础构建系统的。Cloud Native 架构的组成大致如下图所示：

![could-native architectural composition](https://sherlockblaze.com/resources/img/profession/architectures/cloud-native-architectural-composition.png)

**研发流程角度**： 自动化的研发环境是 Cloud Native 的基础。因为使用云作为基础设施，已经具备基础的自动化能力，可以达到自服务的要求，流程中应该尽量减少沟通人员的规模，尽量减少测试及运维对开发的协助，最好由全栈工程师独自、快速完成交付。**保持各环境一致，容器使这一点更容易实现。**

### Cloud Native 背后的诉求

业务快速增长的时代，产品需要更快的交付速度，更好的用户体验，机会转瞬即逝。交付速度的提高不能以降低可用性为代价。Cloud Native 通过一系列的工具、方法减少发布导致的可用性问题。交付速度的提高不能以降低可用性为代价，Cloud Native 通过一系列工具、方法

## 总结

以上四代架构的进化史：

**MVC 架构：** 当业务规模很小时，将所有功能都部署在同一个进程中，通过双机或者前置负载均衡器实现负载分流；此时，用于分离前后台逻辑的MVC架构是关键。
**RPC 架构：** 当垂直应用越来越多，应用之间交互不可避免，将核心和公共业务抽取出来，作为独立的服务，实现前后台逻辑分离。此时，用于提高业务复用及拆分的 RPC 框架是关键。
**SOA 架构：** 随着业务的发展，服务数量越来越多，服务生命周期管控和运行态的治理成为瓶颈，此时用于提升服务质量的 SOA 服务治理是关键。
**微服务架构：** 随着敏捷开发、持续交付、DevOps 理论的发展和实践，以及基于 Docker 等轻量级容器(LXC)部署应用和服务的成熟，微服务架构开始流行，逐渐成为应用架构未来演进方向。通过服务的原子化拆分，以及微服务的独立打包、部署和升级，小团队敏捷交付，应用的交付周期将缩短，运维成本也将大幅下降。